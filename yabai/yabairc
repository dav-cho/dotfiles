#!/usr/bin/env bash

yabai -m signal --add event=dock_did_restart action="sudo yabai --load-sa"
sudo yabai --load-sa

yabai -m config \
  window_zoom_persist 'off' \
  window_shadow 'float' \
  normal_window_opacity '1.0' \
  window_animation_duration '0.0' \
  split_ratio '0.5' \
  mouse_modifier 'alt' \
  mouse_action1 'move' \
  mouse_action2 'resize' \
  mouse_drop_action 'stack' \
  layout 'stack' \
  top_padding '10' \
  bottom_padding '10' \
  left_padding '10' \
  right_padding '10' \
  window_gap '10'

yabai -m rule --add \
  sub-layer="normal"

yabai -m rule --add \
  app!="^(Alacritty|kitty|Google Chrome|Firefox)$" \
  manage=off

yabai -m rule --add \
  app="Google Chrome" \
  title="^(Bitwarden.*|Task Manager)$" \
  manage=off

yabai -m rule --add \
  app="Firefox" \
  title="Library|^Extension:" \
  manage=off

yabai -m signal --add \
  event='window_created' \
  action='yabai -m window $YABAI_WINDOW_ID --sub-layer normal'

yabai -m signal --add \
  event=window_minimized \
  action='yabai -m query --windows --window $YABAI_WINDOW_ID |
          jq -e '\''."is-floating" == false'\'' >/dev/null &&
          yabai -m window $YABAI_WINDOW_ID --toggle float'

yabai -m signal --add \
  event=window_deminimized \
  action='yabai -m query --spaces --space |
          jq -e '\''.type == "stack"'\'' >/dev/null &&
          yabai -m query --windows --window $YABAI_WINDOW_ID |
          jq -e '\''."is-floating" == true'\'' >/dev/null &&
          yabai -m window $YABAI_WINDOW_ID --toggle float'

yabai -m signal --add \
  event='system_woke' \
  action='sleep 1
          for space_id in $(yabai -m query --displays | jq ".[] | select((.frame.x != 0 and .frame.y != 0) and (.frame.h > .frame.w)).spaces[]"); do
            yabai -m config --space "$space_id" layout bsp
            yabai -m config --space "$space_id" auto_balance on
          done'

yabai -m signal --add \
  event='display_added' \
  action='sleep 1
          for space_id in $(yabai -m query --displays | jq ".[] | select((.frame.x != 0 and .frame.y != 0) and (.frame.h > .frame.w)).spaces[]"); do
            yabai -m config --space "$space_id" layout bsp
            yabai -m config --space "$space_id" auto_balance on
          done'

yabai -m signal --add \
  event='display_removed' \
  action='sleep 1
          for space_id in $(yabai -m query --displays | jq ".[] | select((.frame.x != 0 and .frame.y != 0) and (.frame.h > .frame.w)).spaces[]"); do
            yabai -m config --space "$space_id" layout bsp
            yabai -m config --space "$space_id" auto_balance on
          done'

[[ -e "$HOME/._work" && -s "$HOME/dotfiles/work/yabai/yabairc" ]] && source "$HOME/dotfiles/work/yabai/yabairc"
